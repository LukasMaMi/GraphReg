---
title: "01-Estimation_Hub"
output: github_document
---


# Run StARS, G-StARS and Oracle
```{r}

# Define directory path
#dir_path2 <- "C:/R Projekte/StARS_Simulations/workflow/Storage_Estimation_Hub"
dir_path2 <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Estimation_Hub"

# 1. Generate list of file names based on configs
get_filename <- function(config, rep, prefix = "hub") {
  return(sprintf("%s_rep_%d_n_%d_p_%d.RData", prefix, rep, config$n, config$p))
}

# 2. Loop over each file, load dataset, and compute adjacency matrices
for(rep in 1:num_repetitions) {
  for(i in seq_along(configs)) {
    # Get filename for the current configuration and repetition
    filename <- get_filename(configs[[i]], rep)
    
    # Load the dataset
    load(paste0(dir_path, "/", filename))
  
  
  library(QUIC)

  quicr <- function(hub_data, lambda, ...) {
    S <- cov(hub_data)
    est <- QUIC(S, rho = 1, path = lambda, msg = 0, tol = 1e-2, ...)
    est$path <- lapply(seq(length(lambda)), function(i) {
    ## convert precision array to adj list
    tmp <- est$X[,,i]; diag(tmp) <- 0
    tmp <- ifelse(tmp != 0, 1, 0)
    return(tmp)
    })
  est
  }
  
  # Run Pulsar for stars and gstars
  out.p <- pulsar(
    hub_data,
    fun = quicr,
    fargs = (lambda = lambda),
    criterion = c('stars', 'gcd'),
    thresh = 0.1,
    subsample.ratio = b,
    rep.num = N,
    seed = NULL,
    lb.stars = TRUE,
    ub.stars = TRUE,
    ncores = 1,
    refit = FALSE
  )
  
  lam_gam <- get.opt.index(out.p, criterion = "gcd")
  opt.index(out.p, criterion = "gcd") <- lam_gam
  fit <- refit(out.p, criterion = c("stars", "gcd"))
  
  stars_graph <- fit[["refit"]][["stars"]]
  gstars_graph <- fit[["refit"]][["gcd"]]
  
  
  # Oracle computation
  
  #Define Hamming Distance as criterium for Oracle
  hamming_distance <- function(matrix1, matrix2) {
    return(sum(matrix1 != matrix2))
  }
  
  # QUIC with Oracle
  oracle_quic <- function(data, lambda, ...) {
    S <- true_cov
    est <- QUIC(S, rho = 1, path = lambda, msg = 0, tol = 1e-2, ...)
    est$path <- lapply(seq(length(lambda)), function(i) {
    ## convert precision array to adj list
    tmp <- est$X[,,i]; diag(tmp) <- 0
    tmp <- ifelse(tmp != 0, 1, 0)
    return(tmp)
    })
    est
  }
  
  oracle_results <- oracle_quic(hub_data, lambda_path)
  
  best_lambda_index <- which.min(sapply(1:length(lambda_path), function(i) {
    estimated_graph <- oracle_results$path[[i]]
    hamming_distance(estimated_graph, true_graph)
  }))
  
  best_lambda <- lambda_path[best_lambda_index]
  oracle_graph <- oracle_results$X[,,best_lambda_index]
  oracle_graph <- ifelse(oracle_graph != 0, 1, 0)
  diag(oracle_graph) <- 0

    
  # Save results to file
  result_filename <- get_filename(configs[[i]], rep, prefix="estimation")
  save(stars_graph, gstars_graph, oracle_graph, file=paste0(dir_path2, "/", ... = result_filename))
  }
}

print("Adjacency matrices for Hub generated and saved!")
```


## Check
```{r}
# Specify the filename
filename <- "estimation_rep_2_n_800_p_40.RData"

# Load the .RData file
load(paste0(dir_path2, "/", filename))

print(stars_graph)
print(gstars_graph)
print(oracle_graph)

```



