---
title: "01-Estimation_Hub"
output: gitHub_document
---


# Run StARS, G-StARS and Oracle
```{r}

library(pulsar)

Hub_setting_path <- "C:/R Projekte/StARS_Simulations/workflow/Storage_Settings/"
#Hub_setting_path <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Settings/"
hub_settings_file <- file.path(Hub_setting_path, "Hub_settings.RData")
load(hub_settings_file)


# 1. Generate list of file names based on configs
get_filename <- function(config, rep, prefix = "Hub") {
  return(sprintf("%s_rep_%d_n_%d_p_%d.RData", prefix, rep, config$n, config$p))
}

  # 2. Loop over each file, load dataset, and compute adjacency matrices
  for(rep in 1:num_repetitions) {
    for(i in seq_along(configs)) {
      # Get filename for the current configuration and repetition
      filename <- get_filename(configs[[i]], rep)
      
      # Load the dataset
      load(paste0(dir_path, "/", filename))
  
      
  #Define QUIC as method of choice for stars and gstars
  library(QUIC)
  
  quicr <- function(data, lambda, ...) {
    S <- cov(data)
    est <- QUIC(S, rho = 1, path = lambda, msg = 0, tol = 1e-2, ...)
    est$path <- lapply(seq(length(lambda)), function(i) {
    ## convert precision array to adj list
    tmp <- est$X[,,i]; diag(tmp) <- 0
    tmp <- ifelse(tmp != 0, 1, 0)
    return(tmp)
    })
    est
  }
  
  #Run pulsar package
  library(orca)
  out.p <- pulsar(
        data = Hub_data,
        fun = quicr,
        fargs = (lambda = lambda),
        criterion = c('stars', 'gcd'),
        thresh = 0.1,
        subsample.ratio = b,
        rep.num = N,
        seed = NULL,
        lb.stars = TRUE,
        ub.stars = TRUE,
        ncores = 1,
        refit = FALSE
  )
  
  
  # Optimal Index Stars
  stars_index <- out.p[["stars"]][["opt.index"]]
  # Optimal Lambda
  best_lambda_stars <- round(lambda_path[stars_index], 3)
  # Lower Bound
  stars_lb <- out.p[["stars"]][["lb.index"]]
  # Upper Bound
  stars_ub <- out.p[["stars"]][["ub.index"]]

  # Optimal Index Gstars
  lam_gam <- get.opt.index(out.p, criterion = "gcd")
  opt.index(out.p, criterion = "gcd") <- lam_gam
  gstars_index <- out.p[["gcd"]][["opt.index"]][["gcd"]]
  # Optimal Lambda
  best_lambda_gstars <- round(lambda_path[gstars_index], 3)

  
  fit  <- refit(out.p, criterion = c("stars", "gcd"))
  ## Stars
  stars_graph <- fit[["refit"]][["stars"]]
  ## GStars
  gstars_graph <- fit[["refit"]][["gcd"]]
  
  lambd_plot <- plot(out.p, legends = F)
 
  # Oracle procedure
  oracle_results <- quicr(Hub_data, lambda_path)
  
  # F1-Score as criterium for Oracle
  f1_score <- function(predicted, actual) {
      true_positives = sum(predicted[lower.tri(predicted)] & actual[lower.tri(actual)])
      predicted_positives = sum(predicted[lower.tri(predicted)])
      actual_positives = sum(actual[lower.tri(actual)])
  
      precision = ifelse(predicted_positives > 0, true_positives / predicted_positives, 0)
      recall = ifelse(actual_positives > 0, true_positives / actual_positives, 0)
      f1 = ifelse((precision + recall) > 0, 2 * precision * recall / (precision + recall), 0)
  
      return(f1)
  }
  
  # Best lambda Oracle
  oracle_index <- which.max(sapply(1:length(lambda_path), function(i) {
    estimated_graph <- oracle_results$path[[i]]
    f1_score(estimated_graph, true_graph)
  }))
  
  best_lambda_oracle <- lambda_path[oracle_index]
  
  # Extract the oracle precision matrix for the best lambda:
  oracle_graph <- oracle_results$X[,,oracle_index]
  
  # Convert precision matrix to adjacency matrix
  oracle_graph <- ifelse(oracle_graph != 0, 1, 0)
  diag(oracle_graph) <- 0
  
      
  act_sparsity_stars = sum(stars_graph) / (configs[[i]]$p * (configs[[i]]$p - 1))
  act_sparsity_gstars = sum(gstars_graph) / (configs[[i]]$p * (configs[[i]]$p - 1))
  act_sparsity_oracle = sum(oracle_graph) / (configs[[i]]$p * (configs[[i]]$p - 1))
      
  
# Save results to file
dir_path2 <- "C:/R Projekte/StARS_Simulations/workflow/Storage_Estimation_Hub"
#dir_path2 <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Estimation_Hub"
save(num_repetitions, configs, dir_path, dir_path2, file = hub_settings_file)
result_filename <- get_filename(configs[[i]], rep, prefix="estimation")
save(true_graph, stars_graph, gstars_graph, oracle_graph, act_sparsity, act_sparsity_stars, act_sparsity_gstars, act_sparsity_oracle, best_lambda_oracle, best_lambda_stars, best_lambda_gstars, stars_index, gstars_index, oracle_index, stars_lb, stars_ub, out.p, lambd_plot, file=paste0(dir_path2, "/", ... = result_filename))

  }
}

print("Adjacency matrices for Hub generated and saved!")
```


## Check
```{r}
dir_path2 <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Estimation_Hub"

# Get a list of all .RData files in the directory
files <- list.files(path = dir_path2, pattern = "n_800_p_40.*\\.RData$", full.names = TRUE)
files <- list.files(path = dir_path2, pattern = "n_400_p_100.*\\.RData$", full.names = TRUE)
files <- list.files(path = dir_path2, pattern = "n_200_p_200.*\\.RData$", full.names = TRUE)

# Check sparsity
for (file in files) {
  load(file)
  print(act_sparsity)
  print(act_sparsity_oracle)
  print(act_sparsity_stars)
  print(act_sparsity_gstars)
}

# Check lambda index
for (file in files) {
  load(file)
  print(oracle_index)
  print(stars_index)
  print(gstars_index)
}

#Check Plot
for (file in files) {
  load(file)
  print(stars_lb)
  print(stars_ub)
  plot(out.p, legends = F)
}

# Check sparsity differences
for (file in files) {
  load(file)
  print(abs(act_sparsity - act_sparsity_oracle))
  print(abs(act_sparsity - act_sparsity_stars))
  print(abs(act_sparsity - act_sparsity_gstars))
}


# Check adjacency matrices
for (file in files) {
  load(file)
  #print(true_graph)
  #print(oracle_graph)
  print(stars_graph)
  #print(gstars_graph)
}


# Check hamming differences in repetition
oracle_graphs <- list()
stars_graphs <- list()
gstars_graphs <- list()

for (i in 1:length(files)) {
  load(files[i])
  oracle_graphs[[i]] <- oracle_graph
  stars_graphs[[i]] <- stars_graph
  gstars_graphs[[i]] <- gstars_graph
}

difference <- list(sum(oracle_graphs[[1]] != oracle_graphs[[2]]), sum(stars_graphs[[1]] != stars_graphs[[2]]), sum(gstars_graphs[[1]] != gstars_graphs[[2]]))
  print(difference)

  
# Check hamming fit
for (file in files) {
  load(file)
  print(sum(true_graph != true_graph))
  print(sum(oracle_graph != true_graph))
  print(sum(stars_graph != true_graph))
  print(sum(gstars_graph != true_graph))
}

  
# Check plots
for (file in files) {
  load(file)
  Hub <- huge.plot(true_graph)
  Hub_oracle <- huge.plot(oracle_graph)
  Hub_stars <- huge.plot(stars_graph)
  #ER_gstars <- huge.plot(gstars_graph)
}


```



