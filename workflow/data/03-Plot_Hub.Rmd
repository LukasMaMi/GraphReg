---
title: "04-Plot_Hub"
output: github_document
---

```{r}

# Load session settings and performance results
#Hub_setting_path <- "C:/R Projekte/StARS_Simulations/workflow/Storage_Settings/"
Hub_setting_path <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Settings/"
hub_settings_file <- file.path(Hub_setting_path, "Hub_settings.RData")
load(hub_settings_file)

#dir_path3 <- "C:/R Projekte/StARS_Simulations/workflow/Storage_Performance_Hub"
dir_path3 <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Performance_Hub"
performance_filename <- file.path(dir_path3, "all_performance_results.RData")
load(performance_filename)
```


```{r}

#dir_path4 <- "C:/R Projekte/StARS_Simulations/workflow/Storage_Plot_Hub"
dir_path4 <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Storage_Plot_Hub"

# Load necessary libraries
library(ggplot2)
library(dplyr)

# Initialize data frames for various metrics
mean_f1_df <- data.frame(Config = character(), Method = character(), Mean_F1 = numeric(), CI_Lower = numeric(), CI_Upper = numeric(), stringsAsFactors = FALSE)
mean_hamming_df <- data.frame(Config = character(), Method = character(), Mean_Hamming = numeric(), CI_Lower = numeric(), CI_Upper = numeric(), stringsAsFactors = FALSE)
mean_sparsity_df <- data.frame(Config = character(), Method = character(), Mean_Sparsity = numeric(), stringsAsFactors = FALSE)
mean_lambda_df <- data.frame(Config = character(), Method = character(), Mean_Lambda = numeric(), stringsAsFactors = FALSE)

# Loop over configurations
for (cfg_key in names(config_results)) {
  cfg <- config_results[[cfg_key]]

  # Loop over methods (Stars, GStars, Oracle)
  for (method in c("Stars", "GStars", "Oracle_f1", "Oracle_hamming", "Null")) {
    # Aggregated metrics
    aggregated_metrics <- cfg[["Aggregated"]][[tolower(method)]]

    # Mean F1 and Hamming
    mean_f1 <- aggregated_metrics[["Mean"]][1]
    mean_hamming <- aggregated_metrics[["Mean"]][2]

    # Confidence intervals
    ci_f1 <- aggregated_metrics[["CI"]][,1] # F1 CI
    ci_hamming <- aggregated_metrics[["CI"]][,2] # Hamming CI

    # Mean sparsity and lambda values
    mean_sparsity <- aggregated_metrics[["Sparsity"]]
    mean_lambda <- aggregated_metrics[["Lambda"]]

    # Append to data frames
    mean_f1_df <- rbind(mean_f1_df, data.frame(Config = cfg_key, 
                                               Method = method, Mean_F1 = mean_f1, 
                                               CI_Lower = ci_f1[1], CI_Upper = ci_f1[2]))
    
    mean_hamming_df <- rbind(mean_hamming_df, data.frame(Config = cfg_key, 
                                                         Method = method, Mean_Hamming = mean_hamming, 
                                                         CI_Lower = ci_hamming[1], CI_Upper = ci_hamming[2]))
    
    mean_sparsity_df <- rbind(mean_sparsity_df, data.frame(Config = cfg_key, Method = method, Mean_Sparsity = mean_sparsity))
    
    mean_lambda_df <- rbind(mean_lambda_df, data.frame(Config = cfg_key, Method = method, Mean_Lambda = mean_lambda))
    
  }
}

```


## Hub Plots
```{r}

library(ggtext)

# Create custom labels for configurations
config_labels <- sapply(configs, function(cfg) paste("p =", cfg$p, "\nn =", cfg$n))
names(config_labels) <- sapply(configs, function(cfg) paste("n", cfg$n, "p", cfg$p, sep = "_"))

# Add sparsity values with color coding
# For the F1 Plot
config_labels_with_sparsity_f1 <- sapply(names(config_labels), function(cfg_key) {
  sparsity_stars <- round(mean_sparsity_df[mean_sparsity_df$Config == cfg_key & mean_sparsity_df$Method == "Stars", "Mean_Sparsity"], 3)
  sparsity_gstars <- round(mean_sparsity_df[mean_sparsity_df$Config == cfg_key & mean_sparsity_df$Method == "GStars", "Mean_Sparsity"], 3)
  sparsity_oracle_f1 <- round(mean_sparsity_df[mean_sparsity_df$Config == cfg_key & mean_sparsity_df$Method == "Oracle_f1", "Mean_Sparsity"], 3)

  paste(config_labels[cfg_key], 
        "<span style='color:lightblue;'>", sparsity_stars, "</span>",
        "<span style='color:darkorange;'>", sparsity_gstars, "</span>",
        "<span style='color:black;'>", sparsity_oracle_f1, "</span>", 
        sep = "<br>")
}, simplify = FALSE)

# For the Hamming Plot
config_labels_with_sparsity_hamming <- sapply(names(config_labels), function(cfg_key) {
  sparsity_stars <- round(mean_sparsity_df[mean_sparsity_df$Config == cfg_key & mean_sparsity_df$Method == "Stars", "Mean_Sparsity"], 3)
  sparsity_gstars <- round(mean_sparsity_df[mean_sparsity_df$Config == cfg_key & mean_sparsity_df$Method == "GStars", "Mean_Sparsity"], 3)
  sparsity_oracle_hamming <- round(mean_sparsity_df[mean_sparsity_df$Config == cfg_key & mean_sparsity_df$Method == "Oracle_hamming", "Mean_Sparsity"], 3)

  paste(config_labels[cfg_key], 
        "<span style='color:lightblue;'>", sparsity_stars, "</span>",
        "<span style='color:darkorange;'>", sparsity_gstars, "</span>",
        "<span style='color:black;'>", sparsity_oracle_hamming, "</span>", 
        sep = "<br>")
}, simplify = FALSE)


# Filter Data Frames
mean_f1_df_filtered <- mean_f1_df %>% filter(Method != "Oracle_hamming" & Method != "Null")
mean_hamming_df_filtered <- mean_hamming_df %>% filter(Method != "Oracle_f1")

# Update the Config column in mean_f1_df and mean_hamming_df for the F1 plot
mean_f1_df_filtered$Config <- factor(mean_f1_df_filtered$Config, levels = names(config_labels_with_sparsity_f1), labels = config_labels_with_sparsity_f1)

# Update the Config column in mean_f1_df and mean_hamming_df for the Hamming plot
mean_hamming_df_filtered$Config <- factor(mean_hamming_df_filtered$Config, levels = names(config_labels_with_sparsity_hamming), labels = config_labels_with_sparsity_hamming)

# The rest of your plotting code remains the same, except for adding ggtext::element_markdown() to the axis.text.x theme
F1_Hub <- ggplot(mean_f1_df_filtered, aes(x = Config, y = Mean_F1, color = Method)) +
  geom_line(aes(group = Method), linetype = "dotted", linewidth = 1.5) + 
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), width = 0.1, alpha = 0.5) +
  labs(title = "Hub F1 Scores", y = "Mean F1 Score", x = "") +  
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_color_manual(values = c("Stars" = "lightblue", "GStars" = "darkorange", "Oracle_f1" = "black")) +
  theme(axis.text.x = ggtext::element_markdown(angle = 30, hjust = 1)) +
  scale_y_continuous(limits = c(0, 1)) # Set y-axis limits to [0, 1]

Hamming_Hub <- ggplot(mean_hamming_df_filtered, aes(x = Config, y = Mean_Hamming, color = Method)) +
  geom_line(aes(group = Method), linetype = "dotted", linewidth = 1.5) + 
  geom_point(size = 1.5) +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), width = 0.1, alpha = 0.5) +
  labs(title = "Hub Hamming Distances", y = "Mean Hamming Distance", x = "") +  
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_color_manual(values = c("Stars" = "lightblue", "GStars" = "darkorange", "Oracle_hamming" = "black", "Null" = "gray")) +
  theme(axis.text.x = ggtext::element_markdown(angle = 30, hjust = 1))

# Save the plots
ggsave(filename = "F1_Hub_Plot.pdf", plot = F1_Hub, path = dir_path4, width = 8, height = 6, dpi = 300)
ggsave(filename = "Hamming_Hub_Plot.pdf", plot = Hamming_Hub, path = dir_path4, width = 8, height = 6, dpi = 300)

# Display the plots
F1_Hub
Hamming_Hub
```


## Tables for different rhos
```{r}

## Rho 0.1
rho_0_1_path <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Schrott/Hub/rho_0_1"

rho_0_1_hub_settings_file <- file.path(rho_0_1_path, "Hub_settings.RData")
load(rho_0_1_hub_settings_file)

rho_0_1_performance_filename <- file.path(rho_0_1_path, "all_performance_results.RData")
load(rho_0_1_performance_filename)

#
rho_0_1 <- config_results
rm(config_results)
rm(configs)
#


## Rho 0.15
rho_0_15_path <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Schrott/Hub/rho_0_15"

rho_0_15_hub_settings_file <- file.path(rho_0_15_path, "Hub_settings.RData")
load(rho_0_15_hub_settings_file)

rho_0_15_performance_filename <- file.path(rho_0_15_path, "all_performance_results.RData")
load(rho_0_15_performance_filename)

#
rho_0_15 <- config_results
rm(config_results)
rm(configs)
#


## Rho 0.2
rho_0_2_path <- "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Schrott/Hub/rho_0_2"

rho_0_2_hub_settings_file <- file.path(rho_0_2_path, "Hub_settings.RData")
load(rho_0_2_hub_settings_file)

rho_0_2_performance_filename <- file.path(rho_0_2_path, "all_performance_results.RData")
load(rho_0_2_performance_filename)

#
rho_0_2 <- config_results
rm(config_results)
rm(configs)
#


generate_df_for_rho <- function(data_list, rho_descriptor) {
  results_df <- data.frame(Configuration = paste("Results for", rho_descriptor),
                           Method = NA,
                           MeanF1Score = NA,
                           MeanHammingDistance = NA,
                           Sparsity = NA,
                           stringsAsFactors = FALSE)

  add_row <- function(results_df, config, method, data_list) {
    return(rbind(results_df, data.frame(
      Configuration = config,
      Method = method,
      MeanF1Score = data_list[[config]][["Aggregated"]][[method]][["Mean"]][[1]],
      MeanHammingDistance = data_list[[config]][["Aggregated"]][[method]][["Mean"]][[2]],
      Sparsity = data_list[[config]][["Aggregated"]][[method]][["Sparsity"]]
    )))
  }

  configs <- c("n_800_p_40", "n_400_p_100", "n_200_p_200", "n_100_p_400")
  methods <- c("oracle", "stars", "gstars")

  for (config in configs) {
    for (method in methods) {
      results_df <- add_row(results_df, config, method, data_list)
    }
  }

  return(results_df)
}

# Generate data frames for each rho value
df_rho_0_1 <- generate_df_for_rho(rho_0_1, "rho = 0.1")
df_rho_0_15 <- generate_df_for_rho(rho_0_15, "rho = 0.15")
df_rho_0_2 <- generate_df_for_rho(rho_0_2, "rho = 0.2")

# Combine the data frames
combined_df <- rbind(df_rho_0_1, df_rho_0_15, df_rho_0_2)

# Display the combined results
print(combined_df)

library(gridExtra)
table_plot <- tableGrob(combined_df)

library(ggplot2)
ggsave("hub_graph_rho.pdf", table_plot, width = 20, height = 15, path = "/Users/bropc/Documents/LMU/Master Statistics and Data Science/Masterarbeit/R Master/StARS_Simulations/workflow/Schrott/Hub/")


```

## Edge/Graphlet stability plots
```{r}
plot.pulsar <- function(x, scale=TRUE, invlam=FALSE, loglam=FALSE, legends=TRUE, ...) {
    .plot.pulsar(x, scale, invlam, loglam, legends)
}

#' @importFrom graphics plot points legend
#' @keywords internal
.plot.pulsar <- function(x, scale=TRUE, invlam=FALSE, loglam=FALSE, legends=TRUE) {
    fin  <- getArgs(getCall(x), getEnvir(x))
    lams <- fin$fargs$lambda
    xlab <- "lambda"
    if (invlam) {lams <- 1/lams ; xlab <- paste("1/", xlab, sep="")}
    if (loglam) {lams <- log(lams) ; xlab <- paste("log[ ", xlab, " ]", sep="")}

    nlam  <- length(lams)
    crits <- fin$criterion
    n     <- length(crits)
    if (scale) {
        ylab <- "summary (scaled)"
        if ("stars" %in% crits)
            ymax <- max(x$stars$summary)
        else ymax <- 1
    } else {
      ylab <- "summary"
        ymax <- max(unlist(lapply(crits, function(c) x[[ c ]]$summary)))
    }

    yrange <- c(0, ymax)
    plot(lams, seq(yrange[1], yrange[2], length.out=nlam),
         xlab=xlab, ylab=ylab, type='n')
    if (!is.null(x$stars$lb.index)) {
        ilams <- 1:length(lams)
        range1 <- ilams < x$stars$ub.index
        range2 <- ilams > x$stars$lb.index
        range  <- !(range1 | range2)
        ccol   <- vector('numeric', n+1)
        ltys   <- vector('numeric', n+1)
        legs   <- vector('numeric', n+1)
    } else {
        range1 <- rep(FALSE, nlam) ; range2 <- range1
        range  <- !range1
        ccol   <- vector('numeric', n)
        ltys   <- vector('numeric', n)
        legs   <- vector('numeric', n)
    }

    i <- 1 ; lcol <- 1
    optcrits <- c() ; optcols <- c()
    for (cr in crits) {
        summs <- x[[ cr ]]$summary
        optind <- opt.index(x, cr)
        if (scale && cr != "stars") summs <- ymax*summs/max(summs)
        if (length(summs) == nlam) {
            points(lams[range],  summs[range],  type='b', col=lcol)
            points(lams[range1], summs[range1], type='b', col=lcol, lty=2)
            points(lams[range2], summs[range2], type='b', col=lcol, lty=2)
            optind2 <- optind
            if (any(range1 | range2)) {
                ccol[i:(i+1)] <- c(lcol,lcol)
                ltys[i:(i+1)] <- c(2,1)
                legs[i:(i+1)] <- c(paste("b-", cr, sep=""), cr)
                i <- i+1
            } else {
                ccol[i] <- lcol
                ltys[i] <- 1
                legs[i] <- cr
            }
        } else {
            points(lams[range], summs, type='b', col=lcol)
            optind2 <- optind-which(range)[1]+1
            ccol[i] <- lcol
            ltys[i] <- 1
            legs[i] <- cr
        }

        if (!is.null(optind)) {
            points(lams[optind], summs[optind2], type='p', cex=1.5, pch=16, col=lcol)
            optcrits <- c(optcrits, cr)
            optcols  <- c(optcols , lcol)
        }
        lcol <- lcol + 1 ; i <- i + 1
    }

    if (legends) {
        legend('bottomleft', legs, col=ccol, pch=1, lty=ltys, cex=1.4)
        if (length(optcrits) > 0)
          legend('topright', optcrits, pch=16, col=optcols, cex=1.5, title="opt lambda")
    }
}


```

